<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | LLM Acceptably Report</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="{{ url_for('dashboard') }}" class="logo">
                    <div class="logo-icon">&#129302;</div>
                    LLM Acceptably Report
                </a>
                <div class="user-info">
                    <span class="user-name">Logged in as <strong>{{ username }}</strong></span>
                    <a href="{{ url_for('logout') }}" class="btn btn-secondary btn-small">Logout</a>
                </div>
            </div>
        </div>
    </header>

    <main class="dashboard">
        <div class="container">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ 'error' if category == 'error' else 'success' }}">
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <!-- Welcome Section -->
            <div class="welcome-section">
                <h1 class="page-title">
                    Welcome{% if company_name %}, {{ company_name }}{% else %}, {{ username }}{% endif %}!
                </h1>
                <p class="page-subtitle">Your AI Bot Traffic Reports Dashboard</p>
            </div>

            <!-- Quick Stats -->
            {% if stats.total_reports > 0 %}
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">&#128202;</div>
                    <div class="stat-content">
                        <div class="stat-value">{{ stats.total_reports }}</div>
                        <div class="stat-label">Total Reports</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">&#128197;</div>
                    <div class="stat-content">
                        <div class="stat-value">{{ stats.last_report_date or 'N/A' }}</div>
                        <div class="stat-label">Latest Report</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        {% if stats.latest_health == 'excellent' %}&#9989;
                        {% elif stats.latest_health == 'warning' %}&#9888;
                        {% elif stats.latest_health == 'critical' %}&#10060;
                        {% else %}&#8212;{% endif %}
                    </div>
                    <div class="stat-content">
                        <div class="stat-value health-{{ stats.latest_health or 'unknown' }}">
                            {% if stats.latest_health == 'excellent' %}Excellent
                            {% elif stats.latest_health == 'warning' %}Good
                            {% elif stats.latest_health == 'critical' %}Needs Attention
                            {% else %}N/A{% endif %}
                        </div>
                        <div class="stat-label">Latest Health Status</div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Search/Filter (only if multiple reports) -->
            {% if reports|length > 3 %}
            <div class="search-bar">
                <input type="text" id="reportSearch" class="form-input" placeholder="Search reports..." onkeyup="filterReports()">
            </div>
            {% endif %}

            {% if reports %}
                <div class="reports-grid" id="reportsGrid">
                    {% for report in reports %}
                        <div class="report-card" data-name="{{ report.name|lower }}">
                            <!-- Health Status Indicator -->
                            {% if report.summary %}
                            <div class="report-health health-{{ report.summary.health_status or 'unknown' }}">
                                {% if report.summary.health_status == 'excellent' %}&#9989; Excellent
                                {% elif report.summary.health_status == 'warning' %}&#9888; Good
                                {% elif report.summary.health_status == 'critical' %}&#10060; Needs Attention
                                {% else %}&#8212;{% endif %}
                            </div>
                            {% endif %}

                            <h3 class="report-name">{{ report.name }}</h3>
                            <p class="report-date">{{ report.modified_formatted }}</p>

                            <!-- Report Preview/Summary -->
                            {% if report.summary %}
                            <div class="report-summary">
                                {% if report.summary.total_requests %}
                                <div class="summary-item">
                                    <span class="summary-label">AI Requests</span>
                                    <span class="summary-value">{{ report.summary.total_requests }}</span>
                                </div>
                                {% endif %}
                                {% if report.summary.success_rate %}
                                <div class="summary-item">
                                    <span class="summary-label">Success Rate</span>
                                    <span class="summary-value">{{ report.summary.success_rate }}%</span>
                                </div>
                                {% endif %}
                                {% if report.summary.top_bot %}
                                <div class="summary-item">
                                    <span class="summary-label">Top Bot</span>
                                    <span class="summary-value">{{ report.summary.top_bot }}</span>
                                </div>
                                {% endif %}
                            </div>
                            {% endif %}

                            <div class="report-actions">
                                <a href="{{ url_for('view_report', client_id=client_id, report_filename=report.filename) }}"
                                   class="btn btn-primary btn-small"
                                   target="_blank">
                                    View Report
                                </a>
                                <a href="{{ url_for('download_report', client_id=client_id, report_filename=report.filename) }}"
                                   class="btn btn-secondary btn-small">
                                    Download
                                </a>
                            </div>
                        </div>
                    {% endfor %}
                </div>

                <!-- Compare Reports (if 2+ reports) -->
                {% if reports|length >= 2 %}
                <div class="compare-section">
                    <h3>Compare Reports</h3>
                    <p class="compare-hint">See how your AI bot traffic has changed over time</p>
                    <div class="compare-selector">
                        <select id="compareReport1" class="form-input">
                            {% for report in reports %}
                            <option value="{{ loop.index0 }}" {% if loop.index == 1 %}selected{% endif %}>{{ report.name }}</option>
                            {% endfor %}
                        </select>
                        <span class="compare-vs">vs</span>
                        <select id="compareReport2" class="form-input">
                            {% for report in reports %}
                            <option value="{{ loop.index0 }}" {% if loop.index == 2 %}selected{% endif %}>{{ report.name }}</option>
                            {% endfor %}
                        </select>
                        <button class="btn btn-secondary" onclick="compareReports()">Compare</button>
                    </div>
                    <div id="compareResults" class="compare-results" style="display: none;"></div>
                </div>
                {% endif %}

            {% else %}
                <div class="empty-state">
                    <div class="empty-icon">&#128203;</div>
                    <h3 class="empty-title">No Reports Yet</h3>
                    <p class="empty-text">
                        Your AI bot traffic reports will appear here once they're ready.<br>
                        Please check back later or contact your administrator.
                    </p>
                </div>
            {% endif %}
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 Vaseo. All rights reserved. | <a href="https://vaseo.xyz" target="_blank">vaseo.xyz</a></p>
        </div>
    </footer>

    <script>
        // Search/Filter reports
        function filterReports() {
            const searchTerm = document.getElementById('reportSearch').value.toLowerCase();
            const cards = document.querySelectorAll('.report-card');

            cards.forEach(card => {
                const name = card.getAttribute('data-name');
                if (name.includes(searchTerm)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // Compare reports
        const reportsData = [
            {% for report in reports %}
            {
                name: "{{ report.name }}",
                summary: {{ report.summary|tojson if report.summary else 'null' }}
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ];

        function compareReports() {
            const idx1 = parseInt(document.getElementById('compareReport1').value);
            const idx2 = parseInt(document.getElementById('compareReport2').value);

            if (idx1 === idx2) {
                alert('Please select two different reports to compare.');
                return;
            }

            const report1 = reportsData[idx1];
            const report2 = reportsData[idx2];

            if (!report1.summary || !report2.summary) {
                alert('Summary data not available for one or both reports.');
                return;
            }

            const resultsDiv = document.getElementById('compareResults');

            let html = '<div class="compare-grid">';

            // Compare success rates
            if (report1.summary.success_rate && report2.summary.success_rate) {
                const rate1 = parseFloat(report1.summary.success_rate);
                const rate2 = parseFloat(report2.summary.success_rate);
                const diff = rate1 - rate2;
                const trend = diff > 0 ? 'up' : diff < 0 ? 'down' : 'same';

                html += `
                    <div class="compare-item">
                        <div class="compare-label">Success Rate</div>
                        <div class="compare-values">
                            <span>${report1.name}: <strong>${rate1}%</strong></span>
                            <span class="compare-arrow ${trend}">${trend === 'up' ? '↑' : trend === 'down' ? '↓' : '→'}</span>
                            <span>${report2.name}: <strong>${rate2}%</strong></span>
                        </div>
                        <div class="compare-diff ${trend}">
                            ${diff > 0 ? '+' : ''}${diff.toFixed(1)}% change
                        </div>
                    </div>
                `;
            }

            // Compare total requests
            if (report1.summary.total_requests && report2.summary.total_requests) {
                const req1 = parseInt(report1.summary.total_requests.replace(/,/g, ''));
                const req2 = parseInt(report2.summary.total_requests.replace(/,/g, ''));
                const diff = req1 - req2;
                const trend = diff > 0 ? 'up' : diff < 0 ? 'down' : 'same';

                html += `
                    <div class="compare-item">
                        <div class="compare-label">Total AI Requests</div>
                        <div class="compare-values">
                            <span>${report1.name}: <strong>${report1.summary.total_requests}</strong></span>
                            <span class="compare-arrow ${trend}">${trend === 'up' ? '↑' : trend === 'down' ? '↓' : '→'}</span>
                            <span>${report2.name}: <strong>${report2.summary.total_requests}</strong></span>
                        </div>
                        <div class="compare-diff ${trend}">
                            ${diff > 0 ? '+' : ''}${diff.toLocaleString()} requests
                        </div>
                    </div>
                `;
            }

            html += '</div>';

            resultsDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
        }
    </script>
</body>
</html>
